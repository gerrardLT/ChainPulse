# 系统技术架构文档

## 项目名称：ChainPulse - 实时链上事件通知与可视化系统

---

## 1. 整体架构概览

### 1.1 架构设计原则

- **实时性优先**：采用 WebSocket 和事件驱动架构确保毫秒级响应
- **模块化解耦**：前端、后端、索引器、智能合约各司其职
- **可扩展性**：支持多链、多事件类型、多通知渠道
- **高可用性**：使用云原生服务和分布式架构

### 1.2 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层 (Client)                         │
├─────────────────────────────────────────────────────────────────┤
│  Next.js Frontend + Tailwind CSS + Framer Motion                │
│  • 钱包连接 (RainbowKit/Web3Modal)                               │
│  • WebSocket 客户端 (Socket.IO)                                  │
│  • GraphQL 客户端 (Apollo Client)                                │
│  • 可视化组件 (Recharts)                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
                    WebSocket + GraphQL
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                      应用服务层 (Application)                     │
├─────────────────────────────────────────────────────────────────┤
│  Node.js + GraphQL API + Socket.IO Server                       │
│  • 事件聚合服务                                                   │
│  • 实时推送服务                                                   │
│  • 通知管理服务                                                   │
│  • 用户订阅管理                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
                      GraphQL Subscriptions
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                      数据索引层 (Indexer)                        │
├─────────────────────────────────────────────────────────────────┤
│  Envio Indexer                                                   │
│  • 自定义事件定义 (config.yaml)                                  │
│  • 实时事件捕获                                                   │
│  • GraphQL 查询接口                                              │
│  • 事件数据持久化                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
                        RPC / WebSocket
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                       区块链层 (Blockchain)                      │
├─────────────────────────────────────────────────────────────────┤
│  • 智能合约 (ERC-4337 Smart Account)                            │
│  • 业务合约 (NFT, DeFi, DAO 等)                                 │
│  • RPC 节点 (Alchemy/Infura)                                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      基础设施层 (Infrastructure)                 │
├─────────────────────────────────────────────────────────────────┤
│  • 数据库: PostgreSQL (Supabase)                                │
│  • 缓存: Redis (用于实时数据和会话)                              │
│  • 第三方集成: Telegram Bot API, Discord Webhook                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 技术栈详细说明

### 2.1 前端技术栈

| 技术 | 版本 | 用途 | 状态 |
|------|------|------|------|
| **核心框架** |
| Next.js | 15.2.4 | React 框架，App Router | ✅ 已配置 |
| React | 19.x | UI 库 | ✅ 已配置 |
| TypeScript | 5.x | 类型安全 | ✅ 已配置 |
| **样式系统** |
| Tailwind CSS | 4.1.9 | 样式框架 | ✅ 已配置 |
| Tailwindcss Animate | 1.0.7 | 动画工具 | ✅ 已配置 |
| CSS Variables | - | 主题和玻璃态效果 | ✅ 已实现 |
| **UI 组件库** |
| Radix UI | Latest | 无障碍组件基础 | ✅ 已集成 (50+ 组件) |
| Shadcn/UI | Latest | UI 组件集合 | ✅ 已集成 (50+ 组件) |
| Lucide React | 0.454.0 | 图标库 | ✅ 已集成 |
| **表单和验证** |
| React Hook Form | 7.60.0 | 表单管理 | ✅ 已集成 |
| Zod | 3.25.76 | 数据验证 | ✅ 已集成 |
| **数据可视化** |
| Recharts | Latest | 图表库 | ✅ 已实现 (4 个图表) |
| **Web3** |
| Wagmi | Latest | 以太坊 React Hooks | ✅ 已集成 |
| Viem | Latest | 以太坊工具库 | ✅ 已集成 |
| RainbowKit | Latest | 钱包连接 UI | ✅ 已集成 |
| @tanstack/react-query | Latest | 数据请求管理 | ✅ 已集成 |
| **主题和国际化** |
| next-themes | Latest | 主题管理 (明暗模式) | ✅ 已实现 |
| 自定义 i18n | - | 国际化 (中英文) | ✅ 已实现 |
| **通知** |
| Sonner | Latest | Toast 通知 | ✅ 已集成 |
| **待集成** |
| Apollo Client | 3.x | GraphQL 客户端 | ⬜ 待集成 |
| Socket.IO Client | 4.x | WebSocket 通信 | ⬜ 待集成 |
| Framer Motion | 11.x | 高级动画库 | ⬜ 待集成 (使用 CSS 动画)

### 2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 20.x LTS | 运行时环境 |
| Express.js | 4.x | Web 框架 |
| Apollo Server | 4.x | GraphQL 服务器 |
| Socket.IO | 4.x | WebSocket 服务器 |
| TypeScript | 5.x | 类型安全 |
| Prisma | 5.x | ORM 框架 |
| Redis | 7.x | 缓存和消息队列 |
| Zod | 3.x | 数据验证 |

### 2.3 索引器技术栈

| 技术 | 用途 |
|------|------|
| Envio Indexer | 链上事件索引和 GraphQL 服务 |
| PostgreSQL | 事件数据存储 |
| Hasura | 自动生成的 GraphQL API |

### 2.4 智能合约技术栈

| 技术 | 用途 |
|------|------|
| Solidity | 0.8.x |
| ERC-4337 | Account Abstraction 标准 |
| Stackup SDK | 智能账户实现 |
| Hardhat | 开发和测试框架 |

### 2.5 第三方服务

| 服务 | 用途 |
|------|------|
| Supabase | PostgreSQL 托管和实时订阅 |
| Alchemy/Infura | RPC 节点服务 |
| Vercel | 前端部署 |
| Railway/Render | 后端部署 |
| Telegram Bot API | Telegram 通知 |
| Discord Webhook | Discord 通知 |

---

## 3. 核心模块设计

### 3.1 智能账户模块 (Smart Account)

**功能**：
- 用户钱包连接和身份验证
- 智能账户创建和管理
- 自动执行逻辑（Hooks）
- 交易批处理和 Gas 赞助

**技术实现**：
- 使用 Stackup SDK 创建 ERC-4337 智能账户
- 集成 RainbowKit 提供钱包连接界面
- 实现 Account Abstraction Hooks 监听事件触发

**关键接口**：
```typescript
interface SmartAccountService {
  createAccount(owner: Address): Promise<SmartAccount>
  executeTransaction(account: Address, tx: Transaction): Promise<TxHash>
  setupAutoResponse(account: Address, rule: AutoRule): Promise<void>
}
```

### 3.2 链上事件监听模块 (Envio Indexer)

**功能**：
- 定义合约事件索引规则
- 实时捕获链上事件
- 提供 GraphQL 查询接口
- 事件数据持久化

**技术实现**：
- 配置 `config.yaml` 定义监听的合约和事件
- Envio 自动生成 GraphQL schema
- 通过 WebSocket 订阅实时事件流

**核心配置示例**：
```yaml
name: chainpulse-indexer
networks:
  - id: 1
    start_block: 18000000
    contracts:
      - name: SmartAccount
        address: "0x..."
        events:
          - TransactionExecuted
          - AccountCreated
```

### 3.3 实时通知模块

**功能**：
- 接收事件推送
- 用户通知中心
- 消息过滤和分组
- 声音和动画提醒

**技术实现**：
- Socket.IO 建立双向通信
- 前端订阅特定钱包地址的事件
- 使用 Framer Motion 实现动画
- 支持通知优先级和静音设置

**事件推送流程**：
```
Envio Event → Backend Service → Socket.IO → Frontend → UI Notification
```

### 3.4 数据可视化模块

**功能**：
- 交易事件时间轴
- 24小时活跃钱包趋势
- 事件类型分布图
- 智能账户执行状态看板

**技术实现**：
- 使用 Recharts 渲染图表
- GraphQL 查询聚合数据
- 实时数据通过 WebSocket 更新
- 支持自定义时间范围查询

### 3.5 第三方通知集成模块

**功能**：
- Telegram Bot 推送
- Discord Webhook 推送
- 可配置通知规则

**技术实现**：
- Telegram Bot API 发送消息
- Discord Webhook POST 请求
- 用户绑定第三方账号

---

## 4. 数据流设计

### 4.1 事件监听和推送流程

```
[1] 用户发起交易
      ↓
[2] 交易上链并触发事件
      ↓
[3] Envio Indexer 捕获事件
      ↓
[4] 事件写入 PostgreSQL
      ↓
[5] Backend 通过 GraphQL 订阅获取事件
      ↓
[6] Backend 通过 Socket.IO 推送给前端
      ↓
[7] 前端接收并展示通知
      ↓
[8] 更新可视化图表
      ↓
[9] (可选) 触发第三方通知
```

### 4.2 智能账户自动响应流程

```
[1] 监听到特定事件
      ↓
[2] 检查用户配置的自动规则
      ↓
[3] 智能账户验证条件
      ↓
[4] 构建并执行交易
      ↓
[5] 交易结果反馈给用户
```

---

## 5. 项目目录结构

### 5.1 整体结构

```
ChainPulse/                        # 项目根目录
│
├── frontend/                      # Next.js 前端应用 ✅
│   ├── app/                      # App Router (Next.js 15)
│   │   ├── page.tsx              # Dashboard 首页 ✅
│   │   ├── layout.tsx            # 根布局 ✅
│   │   ├── globals.css           # 全局样式 ✅
│   │   ├── events/               # 事件监控页面 ✅
│   │   │   └── page.tsx
│   │   └── settings/             # 设置页面 ✅
│   │       └── page.tsx
│   │
│   ├── components/               # React 组件
│   │   ├── ui/                   # Shadcn/UI 基础组件 ✅ (50+)
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── dropdown-menu.tsx
│   │   │   ├── table.tsx
│   │   │   ├── tabs.tsx
│   │   │   ├── toast.tsx
│   │   │   ├── skeleton.tsx
│   │   │   ├── badge.tsx
│   │   │   ├── avatar.tsx
│   │   │   ├── switch.tsx
│   │   │   ├── select.tsx
│   │   │   └── ... (50+ 组件)
│   │   │
│   │   ├── charts/               # 图表组件 ✅
│   │   │   ├── event-timeline-chart.tsx      # 事件时间轴
│   │   │   ├── event-distribution-chart.tsx  # 事件分布
│   │   │   ├── network-activity-chart.tsx    # 网络活动
│   │   │   └── active-wallets-chart.tsx      # 活跃钱包
│   │   │
│   │   ├── header.tsx            # 顶部导航栏 ✅
│   │   ├── connect-button.tsx    # 钱包连接按钮 ✅
│   │   ├── theme-toggle.tsx      # 主题切换 ✅
│   │   ├── theme-provider.tsx    # 主题提供器 ✅
│   │   ├── language-switcher.tsx # 语言切换器 ✅
│   │   ├── notification-center.tsx   # 通知中心 ✅
│   │   ├── notification-settings.tsx # 通知设置 ✅
│   │   ├── smart-account-card.tsx    # 智能账户卡片 ✅
│   │   └── background-effects.tsx    # 背景动效 ✅
│   │
│   ├── hooks/                    # 自定义 Hooks ✅
│   │   ├── use-mobile.ts         # 移动端检测
│   │   ├── use-toast.ts          # Toast 通知
│   │   ├── use-notifications.ts  # 通知管理
│   │   └── use-smart-account.ts  # 智能账户管理
│   │
│   ├── lib/                      # 工具函数 ✅
│   │   ├── utils.ts              # 通用工具
│   │   ├── i18n/                 # 国际化 ✅
│   │   │   ├── language-context.tsx
│   │   │   └── translations.ts
│   │   └── storage/              # 本地存储 ✅
│   │       └── settings.ts
│   │
│   ├── public/                   # 静态资源 ✅
│   │   └── images/               # 图片资源
│   │       ├── data-flow.jpg
│   │       ├── grid-pattern.jpg
│   │       ├── neon-background.jpg
│   │       └── network-nodes.jpg
│   │
│   ├── styles/                   # 样式文件 ✅
│   │   └── globals.css           # 全局样式 (主题变量、动画)
│   │
│   ├── components.json           # Shadcn/UI 配置 ✅
│   ├── package.json              # 依赖管理 ✅
│   ├── next.config.mjs           # Next.js 配置 ✅
│   ├── tailwind.config.ts        # Tailwind 配置 ✅
│   ├── tsconfig.json             # TypeScript 配置 ✅
│   ├── postcss.config.mjs        # PostCSS 配置 ✅
│   ├── pnpm-lock.yaml            # 锁文件 ✅
│   └── README.md                 # 项目说明 ✅
│
├── backend/                       # Node.js 后端服务
│   ├── src/
│   │   ├── server.ts            # 入口文件
│   │   ├── config/              # 配置文件
│   │   │   ├── database.ts
│   │   │   ├── redis.ts
│   │   │   └── env.ts
│   │   ├── graphql/             # GraphQL Schema 和 Resolvers
│   │   │   ├── schema.ts
│   │   │   ├── typeDefs/
│   │   │   │   ├── user.ts
│   │   │   │   ├── event.ts
│   │   │   │   └── notification.ts
│   │   │   └── resolvers/
│   │   │       ├── user.resolver.ts
│   │   │       ├── event.resolver.ts
│   │   │       └── notification.resolver.ts
│   │   ├── rest/                # REST API 路由
│   │   │   ├── routes/
│   │   │   │   ├── auth.routes.ts
│   │   │   │   ├── user.routes.ts
│   │   │   │   ├── smartAccount.routes.ts
│   │   │   │   └── notification.routes.ts
│   │   │   └── middleware/
│   │   │       ├── auth.middleware.ts
│   │   │       └── validation.middleware.ts
│   │   ├── services/            # 业务逻辑
│   │   │   ├── auth.service.ts
│   │   │   ├── event.service.ts
│   │   │   ├── notification.service.ts
│   │   │   ├── telegram.service.ts
│   │   │   ├── discord.service.ts
│   │   │   └── smartAccount.service.ts
│   │   ├── socket/              # Socket.IO 处理
│   │   │   ├── index.ts
│   │   │   ├── eventHandler.ts
│   │   │   └── notificationHandler.ts
│   │   ├── prisma/              # Prisma ORM
│   │   │   ├── schema.prisma
│   │   │   └── migrations/
│   │   ├── utils/               # 工具函数
│   │   │   ├── logger.ts
│   │   │   ├── jwt.ts
│   │   │   └── validation.ts
│   │   └── types/               # TypeScript 类型
│   │       └── index.ts
│   ├── package.json
│   ├── tsconfig.json
│   └── .env
│
├── contracts/                     # 智能合约
│   ├── contracts/
│   │   ├── SmartAccount.sol     # 智能账户合约
│   │   ├── interfaces/
│   │   │   ├── IAccount.sol
│   │   │   └── IExecutor.sol
│   │   └── libraries/
│   │       └── AccountLib.sol
│   ├── scripts/                 # 部署脚本
│   │   ├── deploy.ts
│   │   └── verify.ts
│   ├── test/                    # 合约测试
│   │   └── SmartAccount.test.ts
│   ├── hardhat.config.ts
│   ├── package.json
│   └── .env
│
├── indexer/                       # Envio 索引器配置
│   ├── config.yaml              # Envio 配置
│   ├── schema.graphql           # GraphQL Schema
│   ├── abis/                    # 合约 ABI
│   │   └── SmartAccount.json
│   └── handlers/                # 事件处理器
│       ├── account.handler.ts
│       └── transaction.handler.ts
│
├── database/                      # 数据库脚本
│   ├── schema.sql               # 数据库初始化脚本
│   ├── seed.sql                 # 测试数据
│   └── README.md                # 数据库使用说明
│
├── docs/                          # 文档
│   ├── 产品需求文档.md
│   ├── 系统技术架构.md
│   ├── 功能交互.md
│   ├── 数据库设计.md
│   ├── API设计.md
│   └── 开发任务清单.md
│
├── .github/                       # GitHub 配置
│   └── workflows/               # CI/CD
│       ├── frontend.yml
│       ├── backend.yml
│       └── contracts.yml
│
├── .gitignore
├── .env.example                   # 环境变量示例
└── README.md                      # 项目说明
```

### 5.2 各模块说明

#### 前端模块 (frontend/) ✅ 已实现基础功能
- **独立的 Next.js 15 项目**
- 包含完整的前端应用代码
- 独立的依赖管理和构建配置 (pnpm)
- 可单独部署到 Vercel

**已实现功能**:
- ✅ Dashboard 仪表板 (4 个可视化图表)
- ✅ 事件监控页面
- ✅ 设置页面
- ✅ 钱包连接 (RainbowKit)
- ✅ 主题切换 (明暗模式)
- ✅ 国际化 (中英文)
- ✅ 通知中心和设置
- ✅ 智能账户卡片
- ✅ 50+ UI 组件 (Shadcn/UI)
- ✅ 玻璃态和霓虹光效 UI 设计
- ✅ 响应式布局

**待集成功能**:
- ⬜ WebSocket 实时通知
- ⬜ GraphQL 数据查询
- ⬜ 用户认证 (JWT)
- ⬜ 智能账户交互
- ⬜ 自动化规则配置

#### 后端模块 (backend/)
- **独立的 Node.js 项目**
- 包含 REST API、GraphQL API 和 WebSocket 服务
- 独立的依赖管理
- 可单独部署到 Railway/Render

#### 智能合约模块 (contracts/)
- **独立的 Hardhat 项目**
- 包含智能合约代码、测试和部署脚本
- 独立的依赖管理
- 可单独编译和部署

#### 索引器模块 (indexer/)
- **Envio 配置目录**
- 包含事件索引配置和处理器
- 部署到 Envio Cloud

#### 数据库脚本 (database/)
- SQL 初始化脚本
- 种子数据
- 数据库文档

---

## 6. 部署架构

### 6.1 开发环境

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Frontend    │     │   Backend    │     │  Indexer     │
│  localhost   │────▶│  localhost   │────▶│  localhost   │
│  :3000       │     │  :4000       │     │  :8080       │
└──────────────┘     └──────────────┘     └──────────────┘
                              │
                              ▼
                    ┌──────────────┐
                    │  PostgreSQL  │
                    │  localhost   │
                    │  :5432       │
                    └──────────────┘
```

### 6.2 生产环境

```
┌─────────────────────────────────────────────────────────────┐
│                        CDN (Vercel)                         │
│                     chainpulse.app                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Next.js Frontend (Vercel)                  │
│              - SSR/SSG                                      │
│              - API Routes                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Backend Service (Railway/Render)               │
│              - GraphQL API                                  │
│              - Socket.IO Server                             │
│              - Notification Service                         │
└─────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴──────────────┐
                ▼                            ▼
┌──────────────────────┐        ┌──────────────────────┐
│  Envio Indexer       │        │  Supabase            │
│  (Envio Cloud)       │        │  - PostgreSQL        │
│  - Event Indexing    │        │  - Realtime          │
│  - GraphQL API       │        │  - Auth              │
└──────────────────────┘        └──────────────────────┘
                              
                ┌──────────────────────────────────┐
                │  Blockchain RPC                  │
                │  (Alchemy/Infura)                │
                └──────────────────────────────────┘
```

---

## 7. 安全设计

### 7.1 前端安全

- HTTPS 强制
- CSP (Content Security Policy) 头部配置
- XSS 防护（React 自动转义）
- 钱包签名验证

### 7.2 后端安全

- API Rate Limiting
- CORS 配置
- JWT 身份验证
- 输入验证（Zod）
- SQL 注入防护（Prisma ORM）

### 7.3 智能合约安全

- 权限控制（Ownable）
- 重入攻击防护
- 整数溢出防护（Solidity 0.8+）
- 审计和测试覆盖率 > 90%

---

## 8. 性能优化

### 8.1 前端优化

- Next.js 静态生成和增量静态再生成
- 图片优化（Next/Image）
- 代码分割和懒加载
- React Query 缓存管理

### 8.2 后端优化

- Redis 缓存热点数据
- GraphQL DataLoader 批量查询
- 数据库索引优化
- WebSocket 连接池管理

### 8.3 数据库优化

- 适当的索引策略
- 查询结果缓存
- 连接池配置
- 定期数据归档

---

## 9. 监控和日志

### 9.1 监控指标

- API 响应时间
- WebSocket 连接数
- 事件处理延迟
- 数据库查询性能
- 错误率和异常追踪

### 9.2 日志策略

- 结构化日志（JSON 格式）
- 日志级别：ERROR, WARN, INFO, DEBUG
- 敏感信息脱敏
- 集中式日志收集（可选）

---

## 10. 扩展性设计

### 10.1 多链支持

- 抽象化链交互层
- 配置化的链信息
- 统一的事件格式

### 10.2 水平扩展

- 无状态后端服务
- Redis 共享会话
- 负载均衡器

### 10.3 功能扩展

- 插件化通知渠道
- 自定义事件过滤规则
- 开放 API 供第三方集成

